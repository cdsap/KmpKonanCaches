name: Build

on:
    push:
        branches: [ main]
    pull_request:
concurrency:
    group: build-${{ github.ref }}
    cancel-in-progress: true

jobs:
    iterations:
       name: Generate Iterations
       runs-on: ubuntu-latest
       outputs:
          iterations: ${{ steps.calculate_iterations.outputs.iterations }}
       steps:
         - id: calculate_iterations
           shell: bash
           run: |
             iters="${{ github.event.inputs.iterations }}"
             if [ -z "$iters" ]; then iters=20; fi
   
             list="["
             for i in $(seq 1 "$iters"); do
               if [ "$i" -eq 1 ]; then
                 list="$list\"$i\""
               else
                 list="$list, \"$i\""
               fi
             done
             list="$list]"
             echo "iterations=$list" >> "$GITHUB_OUTPUT"


    build:
        needs: iterations
        strategy:
            matrix:
                java: [17]
                run: ${{ fromJson(iterations.seed.outputs.iterations) }}

        runs-on: ubuntu-latest
        timeout-minutes: 60

        steps:
            - name: Checkout
              uses: actions/checkout@v5

            - uses: cdsap/build-process-watcher@0.3
              with:
                remote_monitoring: 'true'
            - name: Set up JDK ${{ matrix.java }}
              uses: actions/setup-java@v5
              with:
                  distribution: 'temurin'
                  java-version:  ${{ matrix.java }}
#            - name: ðŸ’½ Cache Kotlin Native
#              uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
#              with:
#                  path: ~/.konan/dependencies/
#                  key: c-${{ runner.os }}-konan-${{ hashFiles('**/gradle/libs.versions.toml') }}
#                  restore-keys: |
#                     c-${{ runner.os }}-konan-
      #      - name: Setup Gradle
      #        uses: gradle/actions/setup-gradle@v5

            - name: Execute test binary and cli
              run: |
                  ./gradlew build -x spotlessKotlinCheck
                  ls
                  cd ~/.konan
                  ls -la
              env:
                  DEVELOCITY_ACCESS_KEY: ${{ secrets.GE_TOKEN }}
